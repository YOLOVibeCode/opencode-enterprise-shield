name: Auto-Version and Deploy

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  packages: write

jobs:
  version-and-build:
    name: Auto-Version and Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Calculate next version
        id: version
        run: |
          # Read current version from VERSION file
          CURRENT_VERSION=$(cat VERSION)
          echo "Current version: ${CURRENT_VERSION}"
          
          # Get build number from GitHub run number (always increments)
          BUILD_NUMBER=${{ github.run_number }}
          
          # Parse semantic version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          # Check commit messages for version bump hints
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          if echo "$COMMIT_MSG" | grep -qiE "^(BREAKING CHANGE|major):"; then
            # Major version bump
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            echo "Bumping MAJOR version"
          elif echo "$COMMIT_MSG" | grep -qiE "^(feat|feature|minor):"; then
            # Minor version bump
            MINOR=$((MINOR + 1))
            PATCH=0
            echo "Bumping MINOR version"
          elif echo "$COMMIT_MSG" | grep -qiE "^(fix|patch):"; then
            # Patch version bump
            PATCH=$((PATCH + 1))
            echo "Bumping PATCH version"
          else
            # No bump, just increment build number
            echo "No version bump, using build number"
          fi
          
          # Generate version string
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          FULL_VERSION="${NEW_VERSION}+build.${BUILD_NUMBER}"
          
          echo "New version: ${NEW_VERSION}"
          echo "Full version: ${FULL_VERSION}"
          
          # Output for other steps
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "full_version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "major=${MAJOR}" >> $GITHUB_OUTPUT
          echo "minor=${MINOR}" >> $GITHUB_OUTPUT
          echo "patch=${PATCH}" >> $GITHUB_OUTPUT
      
      - name: Update VERSION file
        run: |
          echo "${{ steps.version.outputs.version }}" > VERSION
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Only commit if version changed
          if ! git diff --quiet VERSION; then
            git add VERSION
            git commit -m "chore: Bump version to ${{ steps.version.outputs.version }} [skip ci]"
            git push
          fi

  test:
    name: Test
    needs: version-and-build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        go: ['1.22']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
      
      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...
      
      - name: Upload coverage
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out

  build-binaries:
    name: Build Binaries
    needs: [version-and-build, test]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
          - os: windows
            arch: amd64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      
      - name: Build binary
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          VERSION="${{ needs.version-and-build.outputs.full_version }}"
          BUILD_NUM="${{ needs.version-and-build.outputs.build_number }}"
          BINARY_NAME="enterprise-shield-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}"
          
          if [ "${{ matrix.os }}" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi
          
          mkdir -p dist
          
          echo "Building ${BINARY_NAME}..."
          echo "Version: ${VERSION}"
          echo "Build: ${BUILD_NUM}"
          
          go build \
            -ldflags "-X main.version=${VERSION} -X main.buildNumber=${BUILD_NUM} -X main.buildTime=$(date -u '+%Y-%m-%d_%H:%M:%S') -w -s" \
            -o "dist/${BINARY_NAME}" \
            ./cmd/plugin
          
          # Verify binary
          if [ "${{ matrix.os }}" != "windows" ]; then
            chmod +x "dist/${BINARY_NAME}"
          fi
          
          # Create archive
          cd dist
          if [ "${{ matrix.os }}" = "windows" ]; then
            zip "${BINARY_NAME}.zip" "${BINARY_NAME}"
            sha256sum "${BINARY_NAME}.zip" > "${BINARY_NAME}.zip.sha256"
            rm "${BINARY_NAME}"
          else
            tar -czf "${BINARY_NAME}.tar.gz" "${BINARY_NAME}"
            sha256sum "${BINARY_NAME}.tar.gz" > "${BINARY_NAME}.tar.gz.sha256"
            rm "${BINARY_NAME}"
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*

  create-dev-release:
    name: Create Development Release
    needs: [version-and-build, build-binaries]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: binaries-*
          merge-multiple: true
      
      - name: Generate checksums file
        run: |
          cd dist
          cat *.sha256 > checksums-all.txt
          echo "=== All Checksums ===" >> checksums-all.txt
          sha256sum * >> checksums-all.txt 2>/dev/null || true
      
      - name: Generate release notes
        run: |
          VERSION="${{ needs.version-and-build.outputs.full_version }}"
          BUILD_NUM="${{ needs.version-and-build.outputs.build_number }}"
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          cat > release_notes.md << NOTES
          ## ðŸš§ Development Build ${VERSION}
          
          **Automated development build from main branch**
          
          | Info | Value |
          |------|-------|
          | **Version** | ${VERSION} |
          | **Build Number** | #${BUILD_NUM} |
          | **Commit** | ${SHORT_SHA} |
          | **Date** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |
          | **Branch** | main |
          
          ### âš ï¸ Development Build Warning
          
          This is an **automated development build** from the main branch. While all tests have passed, this may contain experimental features. For production use, install a [stable release](https://github.com/${{ github.repository }}/releases/latest).
          
          ### ðŸ“¦ Quick Install
          
          **Recommended (auto-installs correct platform):**
          \`\`\`bash
          curl -sSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | VERSION=dev bash
          \`\`\`
          
          **Docker:**
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository }}:dev
          \`\`\`
          
          **Go:**
          \`\`\`bash
          go install github.com/${{ github.repository }}/cmd/plugin@main
          \`\`\`
          
          ### ðŸ“‹ Recent Changes (Last 10 commits)
          
          \`\`\`
          $(git log --pretty=format:"- %s (%h) - %an" -10)
          \`\`\`
          
          ### ðŸ” Checksums
          
          \`\`\`
          $(cat dist/checksums-all.txt)
          \`\`\`
          
          ### ðŸ§ª Test Results
          
          âœ… All 24 tests passed on Ubuntu and macOS
          âœ… Linter passed (golangci-lint)
          âœ… Binaries built for 5 platforms
          
          ---
          
          **Build Details:**
          - Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          NOTES
      
      - name: Delete existing dev release
        continue-on-error: true
        run: |
          gh release delete dev --yes
          git push origin :refs/tags/dev || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create development release
        run: |
          gh release create dev \
            --title "Development Build ${{ needs.version-and-build.outputs.full_version }} (Build #${{ needs.version-and-build.outputs.build_number }})" \
            --notes-file release_notes.md \
            --prerelease \
            --target main \
            dist/*.tar.gz dist/*.zip dist/*.sha256 dist/checksums-all.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update dev tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f dev -m "Development build ${{ needs.version-and-build.outputs.full_version }}"
          git push -f origin dev
      
      - name: Create build summary
        run: |
          echo "### ðŸŽ‰ Development Build Published! " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Info | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ needs.version-and-build.outputs.full_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build** | #${{ needs.version-and-build.outputs.build_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Platforms** | Linux (amd64, arm64), macOS (amd64, arm64), Windows (amd64) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release** | [Download binaries](https://github.com/${{ github.repository }}/releases/tag/dev) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Users can install with:**" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl -sSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | VERSION=dev bash" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  build-docker:
    name: Build and Push Docker
    needs: [version-and-build, test]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:dev
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:build-${{ needs.version-and-build.outputs.build_number }}
            ghcr.io/${{ github.repository }}:${{ needs.version-and-build.outputs.version }}
          labels: |
            org.opencontainers.image.version=${{ needs.version-and-build.outputs.full_version }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.build-number=${{ needs.version-and-build.outputs.build_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.version-and-build.outputs.full_version }}
            BUILD_NUMBER=${{ needs.version-and-build.outputs.build_number }}

